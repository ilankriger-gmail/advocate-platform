{
  "feature": "Extract duplicated admin authorization pattern into reusable utility",
  "description": "Refactor the admin/creator authorization check pattern that is duplicated 19+ times across action files (challenges.ts, rewards.ts, events.ts, admin.ts) into reusable utility functions in src/lib/auth.ts",
  "created_at": "2026-01-07T14:25:35.146Z",
  "updated_at": "2026-01-07T16:57:52.682Z",
  "status": "in_progress",
  "planStatus": "in_progress",
  "workflow_type": "development",
  "services_involved": [
    "actions",
    "lib"
  ],
  "spec_file": "spec.md",
  "phases": [
    {
      "phase": 1,
      "name": "Create auth utility module",
      "description": "Create a new src/lib/auth.ts module with reusable authorization helper functions",
      "status": "pending",
      "subtasks": [
        {
          "id": "1.1",
          "title": "Create src/lib/auth.ts with AuthResult types",
          "description": "Create the new auth utility file with TypeScript types for AuthResult (authenticated user with profile data) and AuthError (error object). The AuthResult should include user ID, profile data (role, is_creator), and the supabase client for continued use.",
          "status": "completed",
          "files": [
            "src/lib/auth.ts"
          ],
          "estimated_lines": 40,
          "notes": "Created src/lib/auth.ts with TypeScript types: AuthResult (with user, profile, and supabase client), AuthError, UserProfile, AuthResponse union type, and isAuthError type guard helper function. Total 48 lines added.",
          "updated_at": "2026-01-07T14:37:53.757460+00:00"
        },
        {
          "id": "1.2",
          "title": "Implement requireAuth function",
          "description": "Create requireAuth() function that returns the authenticated user or an error object. This is the base function that gets the current user session without checking permissions.",
          "status": "completed",
          "files": [
            "src/lib/auth.ts"
          ],
          "estimated_lines": 25,
          "notes": "Created requireAuth() function in src/lib/auth.ts. The function handles basic authentication by getting the current user session from Supabase and fetching their profile data. Returns AuthResult with user, profile, and supabase client on success, or AuthError on failure. Follows existing patterns with Portuguese error messages. Total 47 lines added including JSDoc documentation.",
          "updated_at": "2026-01-07T14:39:32.886720+00:00"
        },
        {
          "id": "1.3",
          "title": "Implement requireAdminOrCreator function",
          "description": "Create requireAdminOrCreator() function that checks if user has role='admin' OR is_creator=true. Returns user data with profile or error. This handles the most common authorization pattern (16 occurrences).",
          "status": "completed",
          "files": [
            "src/lib/auth.ts"
          ],
          "estimated_lines": 35,
          "notes": "Created requireAdminOrCreator() function in src/lib/auth.ts. The function checks if user has role='admin' OR is_creator=true. Returns AuthResult with user, profile, and supabase client on success, or AuthError on failure. Follows existing patterns with Portuguese error messages. Total 34 lines added including JSDoc documentation. This handles the most common authorization pattern (16 occurrences).",
          "updated_at": "2026-01-07T14:41:32.346522+00:00"
        },
        {
          "id": "1.4",
          "title": "Implement requireAdmin function",
          "description": "Create requireAdmin() function that checks if user has role='admin' only. Returns user data with profile or error. This handles the admin-only authorization pattern (5 occurrences).",
          "status": "completed",
          "files": [
            "src/lib/auth.ts"
          ],
          "estimated_lines": 30,
          "notes": "Created requireAdmin() function in src/lib/auth.ts. The function checks if user has role='admin' only. Returns AuthResult with user, profile, and supabase client on success, or AuthError on failure. Follows existing patterns with Portuguese error messages. Total 33 lines added including JSDoc documentation. This handles the admin-only authorization pattern (5 occurrences).",
          "updated_at": "2026-01-07T14:43:30.885056+00:00"
        }
      ]
    },
    {
      "phase": 2,
      "name": "Refactor challenges.ts",
      "description": "Replace all 8 duplicated authorization blocks in challenges.ts with the new auth utility functions",
      "status": "pending",
      "subtasks": [
        {
          "id": "2.1",
          "title": "Refactor approveParticipation in challenges.ts",
          "description": "Replace the 12-line authorization block in approveParticipation with requireAdminOrCreator() call. Import the auth utility and handle the result pattern.",
          "status": "completed",
          "files": [
            "src/actions/challenges.ts"
          ],
          "estimated_lines": -8,
          "notes": "Successfully refactored approveParticipation in challenges.ts. Replaced the 12-line authorization block (createClient, getUser, profile check) with requireAdminOrCreator() call. The function now uses the centralized auth utility, reducing code duplication and following the new pattern. Net reduction of ~10 lines. Commit: 2160de1",
          "updated_at": "2026-01-07T16:38:10.516762+00:00"
        },
        {
          "id": "2.2",
          "title": "Refactor rejectParticipation in challenges.ts",
          "description": "Replace the authorization block in rejectParticipation with requireAdminOrCreator() call.",
          "status": "completed",
          "files": [
            "src/actions/challenges.ts"
          ],
          "estimated_lines": -8,
          "notes": "Successfully refactored rejectParticipation in challenges.ts. Replaced the 17-line authorization block (createClient, getUser, profile check) with requireAdminOrCreator() call. The function now uses the centralized auth utility, reducing code duplication and following the new pattern. Net reduction of ~10 lines. Commit: 98359e0",
          "updated_at": "2026-01-07T16:39:57.579592+00:00"
        },
        {
          "id": "2.3",
          "title": "Refactor toggleChallengeActive in challenges.ts",
          "description": "Replace the authorization block in toggleChallengeActive with requireAdminOrCreator() call.",
          "status": "completed",
          "files": [
            "src/actions/challenges.ts"
          ],
          "estimated_lines": -8,
          "notes": "Successfully refactored toggleChallengeActive in challenges.ts. Replaced the 17-line authorization block (createClient, getUser, profile check) with requireAdminOrCreator() call. The function now uses the centralized auth utility, reducing code duplication and following the new pattern. Net reduction of ~10 lines. Commit: b0cab2d",
          "updated_at": "2026-01-07T16:41:56.461549+00:00"
        },
        {
          "id": "2.4",
          "title": "Refactor markWinnerPaid in challenges.ts",
          "description": "Replace the authorization block in markWinnerPaid with requireAdminOrCreator() call.",
          "status": "completed",
          "files": [
            "src/actions/challenges.ts"
          ],
          "estimated_lines": -8,
          "notes": "Successfully refactored markWinnerPaid in challenges.ts. Replaced the 17-line authorization block (createClient, getUser, profile check) with requireAdminOrCreator() call. The function now uses the centralized auth utility, reducing code duplication and following the new pattern. Net reduction of ~10 lines. Commit: 3f17531",
          "updated_at": "2026-01-07T16:43:14.067370+00:00"
        },
        {
          "id": "2.5",
          "title": "Refactor createChallenge in challenges.ts",
          "description": "Replace the authorization block in createChallenge with requireAdminOrCreator() call.",
          "status": "completed",
          "files": [
            "src/actions/challenges.ts"
          ],
          "estimated_lines": -8,
          "notes": "Successfully refactored createChallenge in challenges.ts. Replaced the 17-line authorization block (createClient, getUser, profile check) with requireAdminOrCreator() call. The function now uses the centralized auth utility, reducing code duplication and following the new pattern. Net reduction of ~10 lines. Commit: 81cffe4",
          "updated_at": "2026-01-07T16:44:29.693331+00:00"
        },
        {
          "id": "2.6",
          "title": "Refactor closeChallenge in challenges.ts",
          "description": "Replace the authorization block in closeChallenge with requireAdminOrCreator() call.",
          "status": "completed",
          "files": [
            "src/actions/challenges.ts"
          ],
          "estimated_lines": -8,
          "notes": "Successfully refactored closeChallenge in challenges.ts. Replaced the 17-line authorization block (createClient, getUser, profile check) with requireAdminOrCreator() call. The function now uses the centralized auth utility, reducing code duplication and following the new pattern. Net reduction of ~10 lines. Commit: d4e8de5",
          "updated_at": "2026-01-07T16:46:23.293910+00:00"
        },
        {
          "id": "2.7",
          "title": "Refactor registerWinner in challenges.ts",
          "description": "Replace the authorization block in registerWinner with requireAdminOrCreator() call.",
          "status": "completed",
          "files": [
            "src/actions/challenges.ts"
          ],
          "estimated_lines": -8,
          "notes": "Successfully refactored registerWinner in challenges.ts. Replaced the 17-line authorization block (createClient, getUser, profile check) with requireAdminOrCreator() call. The function now uses the centralized auth utility, reducing code duplication and following the new pattern. Net reduction of ~10 lines. Commit: 714bb11",
          "updated_at": "2026-01-07T16:59:04.579613+00:00"
        },
        {
          "id": "2.8",
          "title": "Refactor markPrizeSent in challenges.ts",
          "description": "Replace the authorization block in markPrizeSent with requireAdminOrCreator() call.",
          "status": "pending",
          "files": [
            "src/actions/challenges.ts"
          ],
          "estimated_lines": -8
        }
      ]
    },
    {
      "phase": 3,
      "name": "Refactor rewards.ts",
      "description": "Replace all 7 duplicated authorization blocks in rewards.ts with the new auth utility functions",
      "status": "pending",
      "subtasks": [
        {
          "id": "3.1",
          "title": "Refactor toggleRewardActive in rewards.ts",
          "description": "Replace the authorization block in toggleRewardActive with requireAdminOrCreator() call.",
          "status": "pending",
          "files": [
            "src/actions/rewards.ts"
          ],
          "estimated_lines": -8
        },
        {
          "id": "3.2",
          "title": "Refactor approveClaim in rewards.ts",
          "description": "Replace the authorization block in approveClaim with requireAdminOrCreator() call.",
          "status": "pending",
          "files": [
            "src/actions/rewards.ts"
          ],
          "estimated_lines": -8
        },
        {
          "id": "3.3",
          "title": "Refactor markClaimShipped in rewards.ts",
          "description": "Replace the authorization block in markClaimShipped with requireAdminOrCreator() call.",
          "status": "pending",
          "files": [
            "src/actions/rewards.ts"
          ],
          "estimated_lines": -8
        },
        {
          "id": "3.4",
          "title": "Refactor markClaimDelivered in rewards.ts",
          "description": "Replace the authorization block in markClaimDelivered with requireAdminOrCreator() call.",
          "status": "pending",
          "files": [
            "src/actions/rewards.ts"
          ],
          "estimated_lines": -8
        },
        {
          "id": "3.5",
          "title": "Refactor createReward in rewards.ts",
          "description": "Replace the authorization block in createReward with requireAdminOrCreator() call.",
          "status": "pending",
          "files": [
            "src/actions/rewards.ts"
          ],
          "estimated_lines": -8
        },
        {
          "id": "3.6",
          "title": "Refactor updateReward in rewards.ts",
          "description": "Replace the authorization block in updateReward with requireAdmin() call. Note: this function uses admin-only check (users table, role only).",
          "status": "pending",
          "files": [
            "src/actions/rewards.ts"
          ],
          "estimated_lines": -8
        },
        {
          "id": "3.7",
          "title": "Refactor addCoinsToUser in rewards.ts",
          "description": "Replace the authorization block in addCoinsToUser with requireAdminOrCreator() call.",
          "status": "pending",
          "files": [
            "src/actions/rewards.ts"
          ],
          "estimated_lines": -8
        }
      ]
    },
    {
      "phase": 4,
      "name": "Refactor events.ts",
      "description": "Replace all 4 duplicated authorization blocks in events.ts with the new auth utility functions",
      "status": "pending",
      "subtasks": [
        {
          "id": "4.1",
          "title": "Refactor createEvent in events.ts",
          "description": "Replace the authorization block in createEvent with requireAdminOrCreator() call.",
          "status": "pending",
          "files": [
            "src/actions/events.ts"
          ],
          "estimated_lines": -8
        },
        {
          "id": "4.2",
          "title": "Refactor toggleEventActive in events.ts",
          "description": "Replace the authorization block in toggleEventActive with requireAdminOrCreator() call.",
          "status": "pending",
          "files": [
            "src/actions/events.ts"
          ],
          "estimated_lines": -8
        },
        {
          "id": "4.3",
          "title": "Refactor updateEvent in events.ts",
          "description": "Replace the authorization block in updateEvent with requireAdmin() call. Note: this function uses admin-only check.",
          "status": "pending",
          "files": [
            "src/actions/events.ts"
          ],
          "estimated_lines": -8
        },
        {
          "id": "4.4",
          "title": "Refactor confirmEventRegistration in events.ts",
          "description": "Replace the authorization block in confirmEventRegistration with requireAdmin() call. Note: this function uses admin-only check.",
          "status": "pending",
          "files": [
            "src/actions/events.ts"
          ],
          "estimated_lines": -8
        }
      ]
    },
    {
      "phase": 5,
      "name": "Refactor admin.ts",
      "description": "Replace the duplicated authorization blocks in admin.ts with the new auth utility functions",
      "status": "pending",
      "subtasks": [
        {
          "id": "5.1",
          "title": "Refactor approveParticipation in admin.ts",
          "description": "Replace the authorization block in approveParticipation with requireAdmin() call.",
          "status": "pending",
          "files": [
            "src/actions/admin.ts"
          ],
          "estimated_lines": -8
        },
        {
          "id": "5.2",
          "title": "Refactor rejectParticipation in admin.ts",
          "description": "Replace the authorization block in rejectParticipation with requireAdmin() call.",
          "status": "pending",
          "files": [
            "src/actions/admin.ts"
          ],
          "estimated_lines": -8
        }
      ]
    },
    {
      "phase": 6,
      "name": "Testing and verification",
      "description": "Verify TypeScript compilation, run tests if available, and ensure all refactored actions work correctly",
      "status": "pending",
      "subtasks": [
        {
          "id": "6.1",
          "title": "Run TypeScript compilation check",
          "description": "Run tsc --noEmit to verify all type checking passes after refactoring. Fix any type errors found.",
          "status": "pending",
          "files": [],
          "estimated_lines": 0
        },
        {
          "id": "6.2",
          "title": "Run existing tests",
          "description": "Run any existing tests to ensure the refactoring didn't break functionality.",
          "status": "pending",
          "files": [],
          "estimated_lines": 0
        },
        {
          "id": "6.3",
          "title": "Verify build succeeds",
          "description": "Run next build to ensure the application builds correctly with the refactored code.",
          "status": "pending",
          "files": [],
          "estimated_lines": 0
        }
      ]
    }
  ],
  "total_subtasks": 25,
  "estimated_net_lines": -80,
  "files_affected": [
    "src/lib/auth.ts",
    "src/actions/challenges.ts",
    "src/actions/rewards.ts",
    "src/actions/events.ts",
    "src/actions/admin.ts"
  ],
  "patterns_identified": {
    "admin_or_creator_pattern": {
      "description": "Checks profiles table for role='admin' OR is_creator=true",
      "occurrences": 16,
      "files": [
        "challenges.ts (8)",
        "rewards.ts (5)",
        "events.ts (2)"
      ]
    },
    "admin_only_pattern": {
      "description": "Checks users table for role='admin' only",
      "occurrences": 5,
      "files": [
        "rewards.ts (1)",
        "events.ts (2)",
        "admin.ts (2)"
      ]
    }
  },
  "notes": [
    "Some functions use 'profiles' table while others use 'users' table - will standardize to 'profiles'",
    "Error messages should be consistent: 'Usuario nao autenticado' and 'Acesso nao autorizado'",
    "The auth utility returns both the authenticated user and supabase client for continued use",
    "All refactored functions will use early return pattern with the auth check result"
  ],
  "final_acceptance": [
    "TypeScript compilation passes without errors",
    "All existing tests pass",
    "Application builds successfully",
    "Authorization pattern is DRY - no more duplicated auth code blocks"
  ],
  "qa_signoff": {
    "status": "pending",
    "issues": "",
    "tests_passed": ""
  },
  "last_updated": "2026-01-07T16:59:04.579623+00:00"
}